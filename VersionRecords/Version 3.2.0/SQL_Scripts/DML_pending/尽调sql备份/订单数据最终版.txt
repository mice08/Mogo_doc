SELECT 
  oder_signedorder.id '签约单id',
  flat_flats.`flatsNum` '房源编号',
  oder_signedorder.`roomId` '房间id',
  oder_signedorder.`renterId` '租客id',
  oder_signedorder.`landlordId` '房东id',
  oder_signedorder.`createTime` '创建时间',
  cntr_salecontract.`signingDate` '签约时间',
  CASE
    WHEN cntr_salecontract.`turnStrtus` = 0 
    THEN '否' 
    WHEN cntr_salecontract.`turnStrtus` > 0 
    THEN '是' 
  END '是否转客',
  CASE
    oder_signedorder.STATUS 
    WHEN 0 
    THEN '签约不通过' 
    WHEN 1 
    THEN '签约待审核' 
    WHEN 2 
    THEN '签约待支付' 
    WHEN 3 
    THEN '签约资料有误' 
    WHEN 4 
    THEN '签约成功' 
    WHEN 5 
    THEN '已退房' 
    WHEN 6 
    THEN '合同到期未退房' 
    WHEN 7 
    THEN '转客待确认' 
    WHEN 8 
    THEN '转客待修改' 
    WHEN 21 
    THEN '支付待确认' 
    WHEN 22 
    THEN '签约已撤销' 
    WHEN 23 
    THEN '首期款已付待处理' 
    WHEN 24 
    THEN '租约待确认' 
    WHEN 98 
    THEN '签约已过期' 
    WHEN 99 
    THEN '已删除' 
  END '签约单状态',
  DATE_FORMAT(
    cntr_salecontract.`beginDate`,
    '%Y-%m-%d'
  ) '合同开始日期',
  DATE_FORMAT(
    cntr_salecontract.`endDate`,
    '%Y-%m-%d'
  ) '合同结束日期',
  DATE_FORMAT(
    oder_signedorder.`checkOutTime`,
    '%Y-%m-%d'
  ) '协商退房时间',
  supp_landlordRefundRecord.`amount` '退房金额',
  cntr_salecontract.realRentPrice '实际月租金',
  comm_paytype.`name` '付款方式',
  bill_saleshouldaccount.money '押金',
  bill_salebill.total '租金线上支付笔数',
  bill_salebill.allamount '租金线上支付金额',
  bill_salebill_other.total '其他费用线上支付次数',
  bill_salebill_other.allamount '其他费用线上支付金额',
  bill_salebill.extotal '租金线下支付笔数',
  bill_salebill.exallamount '租金线下支付金额',
  bill_salebill_other.extotal '其他费用线下支付次数',
  bill_salebill_other.exallamount '其他费用线下支付金额',
  CASE
    WHEN user_special.id IS NOT NULL 
    OR usrenter.id IS NOT NULL 
    THEN '是' 
  END '是否是测试数据' 
FROM
  oder_signedorder 
  LEFT JOIN flat_flats 
    ON flat_flats.id = oder_signedorder.`flatsId` 
  LEFT JOIN cntr_salecontract 
    ON cntr_salecontract.id = oder_signedorder.`saleContractId` 
  LEFT JOIN comm_paytype 
    ON comm_paytype.id = cntr_salecontract.`rentPayType` 
  LEFT JOIN oder_surrenderApply 
    ON oder_surrenderApply.`signedOrderId` = oder_signedOrder.id 
    AND oder_surrenderApply.`status` IN (1, 2) 
  LEFT JOIN supp_landlordRefundRecord 
    ON supp_landlordRefundRecord.`surrenderApplyId` = oder_surrenderApply.`id` 
    AND supp_landlordRefundRecord.`status` IN (1, 2) 
  LEFT JOIN bill_saleshouldaccount 
    ON bill_saleshouldaccount.`signedOrderId` = oder_signedorder.`id` 
    AND bill_saleshouldaccount.`billDtlType` = 10003 
  LEFT JOIN 
    (SELECT 
      COUNT(
        CASE
          WHEN ISNULL(exempt) 
          THEN 1 
        END) total,
      COUNT(
        CASE
          WHEN exempt IS NOT NULL 
          THEN 1 
        END
      ) extotal,
      signedorderid,
      SUM(
        CASE
          WHEN ISNULL(bill_salebill.`exempt`) 
          THEN bill_salebill.`amount` 
        END
      ) allAmount,
      SUM(
        CASE
          WHEN bill_salebill.`exempt` IS NOT NULL 
          THEN bill_salebill.`amount` 
        END
      ) exAllAmount 
    FROM
      bill_salebill 
    WHERE bill_salebill.`valid` = 1 
      AND bill_salebill.`bill_type` IN (1003, 1004) 
      AND bill_salebill.`payStatus` = 1 
    GROUP BY bill_salebill.`signedOrderId`) bill_salebill 
    ON bill_salebill.`signedOrderId` = oder_signedorder.`id` 
  LEFT JOIN 
    (SELECT 
      COUNT(
        CASE
          WHEN ISNULL(exempt) 
          THEN 1 
        END) total,
      COUNT(
        CASE
          WHEN exempt IS NOT NULL 
          THEN 1 
        END
      ) extotal,
      signedorderid,
      SUM(
        CASE
          WHEN ISNULL(bill_salebill.`exempt`) 
          THEN bill_salebill.`amount` 
        END
      ) allAmount,
      SUM(
        CASE
          WHEN bill_salebill.`exempt` IS NOT NULL 
          THEN bill_salebill.`amount` 
        END
      ) exAllAmount 
    FROM
      bill_salebill 
    WHERE bill_salebill.`valid` = 1 
      AND bill_salebill.`bill_type` NOT IN (1003, 1004) 
      AND bill_salebill.`payStatus` = 1 
    GROUP BY bill_salebill.`signedOrderId`) bill_salebill_other 
    ON bill_salebill_other.`signedOrderId` = oder_signedorder.`id` 
  LEFT JOIN user_special 
    ON user_special.`userId` = oder_signedorder.landlordid 
    AND user_special.`userType` = 0 
  LEFT JOIN user_special usrenter 
    ON usrenter.userid = oder_signedorder.`renterId` 
    AND usrenter.`userType` = 4 
    WHERE oder_signedorder.renterid=11526
GROUP BY oder_signedorder.`id` 
