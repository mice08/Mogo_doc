
SELECT
user_renter.realname'租客姓名',
  loan_renter_contract.`contractno` AS '贷款编号',
  user_landlord.`name` AS '房东姓名',
  IFNULL(city.`name`,'') AS '公寓所在城市',
  loan_renter_contract.`landlordId` AS '房东ID',
  user_renter.`id` AS '租客唯一识别码（注册手机号）',
  IFNULL(flat_flats.`flatsNum`,'') AS '房源唯一识别码（房源编号）',
  oder_signedorder.`roomId`'房间id',
  IFNULL(oder_signedorder.id,'') AS '签约单唯一识别码（签约单号）',
   CASE
    oder_signedorder.STATUS 
    WHEN 0 
    THEN '签约不通过' 
    WHEN 1 
    THEN '签约待审核' 
    WHEN 2 
    THEN '签约待支付' 
    WHEN 3 
    THEN '签约资料有误' 
    WHEN 4 
    THEN '签约成功' 
    WHEN 5 
    THEN '已退房' 
    WHEN 6 
    THEN '合同到期未退房' 
    WHEN 7 
    THEN '转客待确认' 
    WHEN 8 
    THEN '转客待修改' 
    WHEN 21 
    THEN '支付待确认' 
    WHEN 22 
    THEN '签约已撤销' 
    WHEN 23 
    THEN '首期款已付待处理' 
    WHEN 24 
    THEN '租约待确认' 
    WHEN 98 
    THEN '签约已过期' 
    WHEN 99 
    THEN '已删除' 
  END '签约单状态',
  IFNULL(cntr_salecontract.beginDate,'') AS '租约起租日期',
  IFNULL(cntr_salecontract.endDate,'') AS '租约结束日期',
  CASE  WHEN loan_landlord_mgmt.`loanStatus`  = 0 THEN '初始化'
	WHEN loan_landlord_mgmt.`loanStatus`  = 1 THEN '放款中'
       WHEN loan_landlord_mgmt.`loanStatus`  = 2 THEN '放款失败'
       WHEN loan_landlord_mgmt.`loanStatus`  = 3 THEN '放款中止'
       WHEN loan_landlord_mgmt.`loanStatus`  = 4 THEN '放款完成'
       WHEN loan_landlord_mgmt.`loanStatus`  = 5 THEN '款项结清'
       WHEN loan_landlord_mgmt.`loanStatus`  = 6 THEN '待买回'
       WHEN loan_landlord_mgmt.`loanStatus`  = 7 THEN '买回款项结清'
   END AS '贷款状态',
   CASE loan_renter_contract.`status`
   WHEN 1 THEN '审核中' WHEN 2 THEN '放款失败'
   WHEN 3 THEN '放款成功' WHEN 4 THEN '已还清'
   WHEN 5 THEN '已逾期' WHEN 6 THEN '审核失败'
   WHEN 7 THEN '合同终止'
   WHEN 8 THEN '取消合同'
   WHEN 9 THEN '钱款结清'
   WHEN 10 THEN '款项到位'
   WHEN 11 THEN '合同待中止'
    END'蘑菇宝状态',

  loan_renter_contract.`applyamt` AS '租客申请金额',
  cntr_salecontract.signingDate '租客申请蘑菇宝时间（蘑菇宝合同创建时间）',
  (SELECT CASE  checkStatus WHEN 0 THEN '拒绝' WHEN 1 THEN '通过' END FROM loan_renter_check WHERE loan_renter_check.`loanContractId` = loan_renter_contract.id AND loan_renter_info.`channel` =  loan_renter_check.`loanChannel`) AS '终审状态',
  (SELECT checkTime FROM loan_renter_check WHERE loan_renter_check.`loanContractId` = loan_renter_contract.id AND loan_renter_info.`channel` =  loan_renter_check.`loanChannel`) AS '蘑菇宝审批通过时间（蘑菇审批）（终审时间）',
 loan_renter_contract.confirmTime AS '资方实际放款时间（财务确认款项到位时间）',
 (SELECT loan_landlord_payplan.payDate FROM loan_landlord_payplan WHERE loan_landlord_payplan.`loanId` = loan_landlord_mgmt.id   AND loan_landlord_payplan.payStatus=4  AND ( loan_landlord_payplan.period=1 AND loan_landlord_payplan.phaseMonths>1) LIMIT 1) AS '蘑菇向二房东实际放款时间（财务确认放款时间）' ,
 IFNULL(loan_landlord_mgmt.`feeRate`,0) AS '放款手续服务费率（万分比）',
 IFNULL( (SELECT loan_landlord_payplan.feeAmount FROM loan_landlord_payplan WHERE loan_landlord_payplan.`loanId` = loan_landlord_mgmt.id   AND ( loan_landlord_payplan.period=1 AND loan_landlord_payplan.phaseMonths>1) LIMIT 1),0) AS '放款手续费金额',
 IFNULL( (SELECT loan_landlord_payplan.depositAmount FROM loan_landlord_payplan WHERE loan_landlord_payplan.`loanId` = loan_landlord_mgmt.id   AND ( loan_landlord_payplan.period=1 AND loan_landlord_payplan.phaseMonths>1) LIMIT 1),0) AS '放款成功保证金（租金宝保证金）',
 IFNULL( (SELECT loan_landlord_payplan.`actualAmount` FROM loan_landlord_payplan WHERE loan_landlord_payplan.`loanId` = loan_landlord_mgmt.id   AND ( loan_landlord_payplan.period=1 AND loan_landlord_payplan.phaseMonths>1) LIMIT 1),0)  AS '实际放款净额',
loan_renter_info.period  AS '放款期数',
cntr_salecontract.payDate AS '租客每月还款日期',
/*ROUND(IFNULL(loan_renter_info.applicant,0)/IFNULL(loan_renter_info.`period`,1),2) AS '租客每期还款本金',*/
cntr_salecontract.`realRentPrice`'租客每期还款本金',
(SELECT COUNT(DISTINCT loan_landlord_repayplan.`period`) FROM loan_landlord_repayplan WHERE loan_landlord_repayplan.`loanId`  =  loan_landlord_mgmt.`id`  AND loan_landlord_repayplan.repayStatus=3 ) AS '已还款期数',
(loan_renter_info.`period`-(SELECT COUNT(DISTINCT loan_landlord_repayplan.`period`) FROM loan_landlord_repayplan WHERE loan_landlord_repayplan.`loanId`  =  loan_landlord_mgmt.`id`  AND loan_landlord_repayplan.repayStatus=3 )) AS '剩余还款期数',
CASE WHEN loan_renter_info.`channel`  = 1 THEN '拉卡拉' ELSE '蘑菇' END AS '资金来源方',
 IFNULL(oder_signedorder.checkOutTime,'')  AS '退房日期',
 CASE WHEN  loan_landlord_buyback.id  IS NULL THEN '否' ELSE '是' END AS   '职业房东是否买回',
 IFNULL(loan_landlord_buyback.`buyBackDate`,'') AS  '职业房东买回日期',
 IFNULL(loan_landlord_buyback.`buyBackAmount`,0) AS '职业房东买回本金',
 IFNULL(loan_landlord_buyback.lateFee,0) AS '职业房东买回手续费',
 IFNULL(loan_landlord_buyback.penalty,0) AS '职业房东买回滞纳金',
 IFNULL(loan_landlord_buyback.backFee,0) AS  '返还职业房东手续费',
 IFNULL(repayedAmount,0) + IFNULL(repayedLateFee,0) + IFNULL(repayedRenterPenalty,0) + IFNULL(repayedPenalty,0)    AS '职业房东实际买回金额'
FROM
  loan_landlord_mgmt 
  RIGHT JOIN (SELECT * FROM loan_renter_contract JOIN (SELECT MAX(id)maxid  FROM loan_renter_contract GROUP BY loan_renter_contract.`infoId`)temp ON temp.maxid = loan_renter_contract.id) loan_renter_contract
    ON loan_landlord_mgmt.`bizContractId` = loan_renter_contract.id 
  LEFT JOIN loan_renter_info 
    ON loan_renter_contract.`infoId` = loan_renter_info.`id` 
  LEFT JOIN oder_signedorder 
    ON loan_renter_info.`signedOrderId` = oder_signedorder.`id` 
  LEFT JOIN user_landlord 
    ON loan_renter_info.`landlordId` = user_landlord.`id` 
  LEFT JOIN flat_flats 
    ON oder_signedorder.`flatsId` = flat_flats.`id` 
  LEFT JOIN flat_community 
    ON flat_community.id = flat_flats.`communityId` 
  LEFT JOIN city_district 
    ON city_district.id = flat_community.`districtId` 
  LEFT JOIN city 
    ON city_district.cityId = city.id 
  LEFT JOIN user_renter 
    ON user_renter.id = loan_renter_contract.`renterId` 
  LEFT JOIN cntr_salecontract 
    ON cntr_salecontract.id = oder_signedorder.`saleContractId` 
    LEFT JOIN loan_landlord_buyback ON  loan_landlord_buyback.loanid = loan_landlord_mgmt.id  
AND (loan_landlord_buyback.`loanChannel` IS NULL OR loan_landlord_buyback.`loanChannel` IN(1,2) ) AND (loan_landlord_buyback.remainPeriod>1  AND loan_landlord_buyback.backFee>0) 
GROUP BY loan_renter_contract.id